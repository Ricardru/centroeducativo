<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico y Reparaci√≥n - Calendario Escolar</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: #388e3c; background: #e8f5e9; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: #1976d2; background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #1565c0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagn√≥stico y Reparaci√≥n - Calendario Escolar</h1>
        
        <div class="info">
            Este script diagnosticar√° y reparar√° los problemas con la tabla calendario_escolar en Supabase.
        </div>

        <div>
            <button onclick="verificarAutenticacion()">1. Verificar Autenticaci√≥n</button>
            <button onclick="verificarTabla()">2. Verificar Tabla</button>
            <button onclick="crearTabla()">3. Crear/Reparar Tabla</button>
            <button onclick="insertarEventoPrueba()">4. Insertar Evento de Prueba</button>
            <button onclick="limpiarLog()">Limpiar Log</button>
        </div>

        <div id="log" class="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://lunrriztthihxlvjyiys.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1bnJyaXp0dGhpaHhsdmp5aXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2Nzk4NzgsImV4cCI6MjA3NjI1NTg3OH0.xlBYYztcz4RV-ngqw7rXUhfbOsS2iE_Nx7ssnZLNf7Y';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function limpiarLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function verificarAutenticacion() {
            log('üîç Verificando autenticaci√≥n...');
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    log(`‚ùå Error al obtener sesi√≥n: ${error.message}`, 'error');
                    return false;
                }
                
                if (session) {
                    log(`‚úÖ Usuario autenticado: ${session.user.email}`, 'success');
                    log(`üîë Token v√°lido hasta: ${new Date(session.expires_at * 1000).toLocaleString()}`);
                    return true;
                } else {
                    log('‚ùå No hay sesi√≥n activa. Necesita autenticarse primero.', 'error');
                    // Intentar login autom√°tico para pruebas
                    await loginAutomatico();
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error inesperado: ${error.message}`, 'error');
                return false;
            }
        }

        async function loginAutomatico() {
            log('üîÑ Intentando login autom√°tico para pruebas...');
            // Este es solo para diagn√≥stico - en producci√≥n no hagas esto
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@centroeducativo.com',
                    password: 'admin123'
                });

                if (error) {
                    log(`‚ùå Error en login autom√°tico: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Login autom√°tico exitoso', 'success');
                }
            } catch (error) {
                log(`‚ùå Error en login: ${error.message}`, 'error');
            }
        }

        async function verificarTabla() {
            log('üîç Verificando existencia de tabla calendario_escolar...');
            try {
                const { data, error } = await supabase
                    .from('calendario_escolar')
                    .select('count(*)')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116' || error.message.includes('relation') || error.message.includes('does not exist')) {
                        log('‚ùå La tabla calendario_escolar no existe', 'error');
                        return false;
                    } else {
                        log(`‚ùå Error al verificar tabla: ${error.message} (C√≥digo: ${error.code})`, 'error');
                        return false;
                    }
                } else {
                    log('‚úÖ La tabla calendario_escolar existe y es accesible', 'success');
                    log(`üìä Registros encontrados: ${JSON.stringify(data)}`);
                    return true;
                }
            } catch (error) {
                log(`‚ùå Error inesperado: ${error.message}`, 'error');
                return false;
            }
        }

        async function crearTabla() {
            log('üöß Creando/reparando tabla calendario_escolar...');
            
            // SQL para crear la tabla y pol√≠ticas
            const createTableSQL = `
                -- Crear tabla calendario_escolar si no existe
                CREATE TABLE IF NOT EXISTS public.calendario_escolar (
                    id uuid NOT NULL DEFAULT gen_random_uuid(),
                    titulo text NOT NULL,
                    descripcion text,
                    fecha_inicio timestamp with time zone NOT NULL,
                    fecha_fin timestamp with time zone,
                    tipo_evento text NOT NULL DEFAULT 'evento'::text,
                    estado text NOT NULL DEFAULT 'activo'::text,
                    created_at timestamp with time zone NOT NULL DEFAULT now(),
                    updated_at timestamp with time zone NOT NULL DEFAULT now(),
                    CONSTRAINT calendario_escolar_pkey PRIMARY KEY (id),
                    CONSTRAINT calendario_escolar_tipo_evento_check CHECK ((tipo_evento = ANY (ARRAY['clase'::text, 'reunion'::text, 'evaluacion'::text, 'actividad'::text, 'feriado'::text, 'evento'::text]))),
                    CONSTRAINT calendario_escolar_estado_check CHECK ((estado = ANY (ARRAY['activo'::text, 'inactivo'::text, 'cancelado'::text])))
                );

                -- Habilitar RLS
                ALTER TABLE public.calendario_escolar ENABLE ROW LEVEL SECURITY;

                -- Pol√≠ticas RLS
                DROP POLICY IF EXISTS "calendario_escolar_select_policy" ON public.calendario_escolar;
                CREATE POLICY "calendario_escolar_select_policy" ON public.calendario_escolar
                    FOR SELECT USING (true);

                DROP POLICY IF EXISTS "calendario_escolar_insert_policy" ON public.calendario_escolar;
                CREATE POLICY "calendario_escolar_insert_policy" ON public.calendario_escolar
                    FOR INSERT WITH CHECK (true);

                DROP POLICY IF EXISTS "calendario_escolar_update_policy" ON public.calendario_escolar;
                CREATE POLICY "calendario_escolar_update_policy" ON public.calendario_escolar
                    FOR UPDATE USING (true) WITH CHECK (true);

                DROP POLICY IF EXISTS "calendario_escolar_delete_policy" ON public.calendario_escolar;
                CREATE POLICY "calendario_escolar_delete_policy" ON public.calendario_escolar
                    FOR DELETE USING (true);
            `;

            try {
                const { data, error } = await supabase.rpc('exec_sql', { query: createTableSQL });
                
                if (error) {
                    log(`‚ùå Error al crear tabla: ${error.message}`, 'error');
                    log('üí° Intente ejecutar este SQL manualmente en el panel de Supabase:', 'info');
                    log(`<pre>${createTableSQL}</pre>`);
                } else {
                    log('‚úÖ Tabla y pol√≠ticas creadas exitosamente', 'success');
                }
            } catch (error) {
                log(`‚ùå La funci√≥n exec_sql no est√° disponible. Use el SQL Manager de Supabase:`, 'error');
                log(`<pre>${createTableSQL}</pre>`);
            }
        }

        async function insertarEventoPrueba() {
            log('üß™ Insertando evento de prueba...');
            
            const eventoPrueba = {
                titulo: 'Evento de Prueba - ' + new Date().toLocaleString(),
                descripcion: 'Este es un evento creado para probar la funcionalidad',
                fecha_inicio: new Date().toISOString(),
                fecha_fin: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2 horas despu√©s
                tipo_evento: 'evento',
                estado: 'activo'
            };

            try {
                const { data, error } = await supabase
                    .from('calendario_escolar')
                    .insert([eventoPrueba])
                    .select();

                if (error) {
                    log(`‚ùå Error al insertar evento: ${error.message}`, 'error');
                    log(`üîç C√≥digo de error: ${error.code}`);
                    log(`üîç Detalles: ${JSON.stringify(error.details)}`);
                    
                    if (error.code === '42501') {
                        log('üí° Error RLS: Las pol√≠ticas de seguridad est√°n bloqueando la inserci√≥n', 'info');
                        log('üí° Soluci√≥n: Verifique que est√© autenticado y que las pol√≠ticas RLS permitan INSERT', 'info');
                    }
                } else {
                    log('‚úÖ Evento insertado exitosamente', 'success');
                    log(`üìù Datos insertados: ${JSON.stringify(data[0], null, 2)}`);
                }
            } catch (error) {
                log(`‚ùå Error inesperado: ${error.message}`, 'error');
            }
        }

        // Ejecutar verificaci√≥n inicial
        window.addEventListener('load', async () => {
            log('üöÄ Iniciando diagn√≥stico del sistema calendario_escolar...');
            await verificarAutenticacion();
        });
    </script>
</body>
</html>